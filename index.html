<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TrankiMama</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 16px; }
    #map { height: 420px; border-radius: 12px; background:#eef1f4; }
    .controls { margin: 12px 0; display: flex; gap: 8px; flex-wrap: wrap; }
    button { padding: 8px 12px; border: 0; border-radius: 8px; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    hr { margin: 16px 0; }
    li { margin: 6px 0; }
    .meta { color:#555; font-size: 0.9em; margin-left: 4px; }
  </style>
</head>
<body>
  <h1>TrankiMama</h1>
  <div id="map"></div>

  <div class="controls">
    <button id="btnStart"  onclick="startTracking()">Comenzar</button>
    <button id="btnStop"   onclick="pauseTracking()" disabled>Detener</button>
    <button id="btnResume" onclick="resumeTracking()" disabled>Retomar</button>
    <button id="btnSave"   onclick="saveRoute()" disabled>Guardar</button>
    <button id="btnClear"  onclick="clearCurrent()" disabled>Limpiar actual</button>
  </div>

  <hr />
  <h2>Mis rutas</h2>
  <ul id="routes"></ul>

  <script>
    // ===== Config de filtrado =====
    const MAX_ACC  = 40; // metros: ignora posiciones con peor precisión
    const MIN_DIST = 5;  // metros: ignora movimientos menores a este umbral

    // ===== Estado =====
    let map;
    let watchId = null;            // null => sin seguimiento activo
    let currentPath = [];          // [{lat, lng, t, acc}]
    let currentPolyline = null;
    let currentMarker = null;
    let drawnPolyline = null;      // para visualizar rutas guardadas
    let routes = [];               // [{id, name, createdAt, distanceMeters, path:[...]}]

    // ===== Inicio =====
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 40.4168, lng: -3.7038 }, // Madrid por defecto
        zoom: 14,
        mapTypeControl: false
      });
      routes = loadFromLocalStorage();
      renderRouteList();
      updateButtons();
    }

    // ===== Helpers =====
    const isTracking = () => watchId !== null;
    const hasCurrent = () => currentPath.length > 0;

    function ensurePolylineAndMarker() {
      if (!currentPolyline) {
        currentPolyline = new google.maps.Polyline({
          path: [],
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 3,
          map
        });
      }
      if (!currentMarker) {
        currentMarker = new google.maps.Marker({ map, title: 'Mi posición' });
      }
    }

    // ===== Comenzar (nueva ruta) =====
    function startTracking() {
      if (isTracking()) return;

      // Si hay trazado actual sin guardar, confirmamos borrar
      if (hasCurrent()) {
        const ok = confirm('Ya tienes un trazado en curso. ¿Deseas descartarlo y comenzar una ruta nueva?');
        if (!ok) return;
        clearCurrent(); // limpia sin preguntar de nuevo
      }

      currentPath = [];
      ensurePolylineAndMarker();

      watchId = navigator.geolocation.watchPosition(onPosition, onGeoError, {
        enableHighAccuracy: true,
        maximumAge: 10_000,
        timeout: 20_000
      });

      updateButtons();
    }

    // ===== Detener (pausa) =====
    function pauseTracking() {
      if (isTracking()) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      updateButtons();
    }

    // ===== Retomar (continúa la misma ruta) =====
    function resumeTracking() {
      if (isTracking() || !hasCurrent()) return; // ya activo o no hay nada que retomar
      ensurePolylineAndMarker();
      watchId = navigator.geolocation.watchPosition(onPosition, onGeoError, {
        enableHighAccuracy: true,
        maximumAge: 10_000,
        timeout: 20_000
      });
      updateButtons();
    }

    // ===== Limpia trazado actual =====
    function clearCurrent() {
      if (isTracking()) pauseTracking();
      currentPath = [];
      if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }
      if (currentMarker)   { currentMarker.setMap(null); currentMarker = null; }
      updateButtons();
    }

    // ===== Posición entrante =====
    function onPosition(pos) {
      const { latitude, longitude, accuracy } = pos.coords;
      if (accuracy > MAX_ACC) return; // filtra mala precisión

      const p = { lat: latitude, lng: longitude, t: Date.now(), acc: accuracy };

      // evita puntos casi iguales (ahorra batería/almacenamiento)
      if (currentPath.length > 0) {
        const last = currentPath[currentPath.length - 1];
        const d = google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(last.lat, last.lng),
          new google.maps.LatLng(p.lat, p.lng)
        );
        if (d < MIN_DIST) { 
          // actualiza la posición del marcador aunque no añadamos punto
          if (currentMarker) currentMarker.setPosition({ lat: p.lat, lng: p.lng });
          return;
        }
      } else {
        map.setCenter({ lat: p.lat, lng: p.lng });
      }

      currentPath.push(p);
      ensurePolylineAndMarker();
      currentPolyline.getPath().push(new google.maps.LatLng(p.lat, p.lng));
      currentMarker.setPosition({ lat: p.lat, lng: p.lng });

      updateButtons();
    }

    function onGeoError(err) {
      console.error('Geolocation error:', err);
      alert('No se pudo obtener la posición (' + err.message + '). Revisa permisos/GPS.');
    }

    // ===== Guardar ruta =====
    function saveRoute() {
      if (currentPath.length < 2) {
        alert('Necesitas al menos dos puntos para guardar una ruta.');
        return;
      }
      const llArray = currentPath.map(p => new google.maps.LatLng(p.lat, p.lng));
      const distanceMeters = google.maps.geometry.spherical.computeLength(llArray);

      const route = {
        id: Date.now(),
        name: `Ruta ${routes.length + 1}`,
        createdAt: new Date().toISOString(),
        distanceMeters,
        path: currentPath
      };

      routes.push(route);
      saveToLocalStorage(routes);
      renderRouteList();

      alert('Ruta guardada.');
      clearCurrent();
    }

    // ===== Lista de rutas =====
    function renderRouteList() {
      const list = document.getElementById('routes');
      list.innerHTML = '';

      if (!routes.length) {
        const li = document.createElement('li');
        li.textContent = 'No tienes rutas guardadas aún.';
        list.appendChild(li);
        return;
      }

      routes.forEach((r) => {
        const li = document.createElement('li');

        const a = document.createElement('a');
        a.href = '#';
        a.textContent = r.name;
        a.onclick = () => { showRoute(r.id); };

        const km = (r.distanceMeters / 1000).toFixed(2);
        const when = new Date(r.createdAt).toLocaleString();

        const meta = document.createElement('span');
        meta.className = 'meta';
        meta.textContent = ` · ${km} km · ${when}`;

        // Exportaciones
        const sep1 = document.createTextNode(' · ');
        const aGJ = document.createElement('a');
        aGJ.href = '#';
        aGJ.textContent = 'GeoJSON';
        aGJ.onclick = () => exportRoute(r.id, 'geojson');

        const sep2 = document.createTextNode(' / ');
        const aGPX = document.createElement('a');
        aGPX.href = '#';
        aGPX.textContent = 'GPX';
        aGPX.onclick = () => exportRoute(r.id, 'gpx');

        li.appendChild(a);
        li.appendChild(meta);
        li.appendChild(sep1);
        li.appendChild(aGJ);
        li.appendChild(sep2);
        li.appendChild(aGPX);
        list.appendChild(li);
      });
    }

    function showRoute(id) {
      const r = routes.find(x => x.id === id);
      if (!r || !r.path?.length) return;

      if (drawnPolyline) drawnPolyline.setMap(null);

      drawnPolyline = new google.maps.Polyline({
        path: r.path.map(p => ({ lat: p.lat, lng: p.lng })),
        geodesic: true,
        strokeColor: '#0371B3',
        strokeOpacity: 1.0,
        strokeWeight: 3,
        map
      });

      const bounds = new google.maps.LatLngBounds();
      r.path.forEach(p => bounds.extend(new google.maps.LatLng(p.lat, p.lng)));
      if (!bounds.isEmpty()) map.fitBounds(bounds);
    }

    // ===== Exportación =====
    function download(name, content, mime) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([content], { type: mime }));
      a.download = name;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function routeToGeoJSON(r) {
      return JSON.stringify({
        type: "Feature",
        properties: {
          id: r.id,
          name: r.name,
          createdAt: r.createdAt,
          distance_m: Math.round(r.distanceMeters)
        },
        geometry: {
          type: "LineString",
          coordinates: r.path.map(p => [p.lng, p.lat]) // [lng, lat]
        }
      }, null, 2);
    }

    function routeToGPX(r) {
      const trkpts = r.path.map(p =>
        `<trkpt lat="${p.lat}" lon="${p.lng}"><time>${new Date(p.t).toISOString()}</time></trkpt>`
      ).join('');
      return `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="TrankiMama" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata><time>${new Date(r.createdAt).toISOString()}</time><name>${r.name}</name></metadata>
  <trk><name>${r.name}</name><trkseg>${trkpts}</trkseg></trk>
</gpx>`;
    }

    function exportRoute(id, fmt) {
      const r = routes.find(x => x.id === id);
      if (!r) return;
      if (fmt === 'geojson') {
        download(`ruta-${r.id}.geojson`, routeToGeoJSON(r), 'application/geo+json');
      } else if (fmt === 'gpx') {
        download(`ruta-${r.id}.gpx`, routeToGPX(r), 'application/gpx+xml');
      }
    }

    // ===== Storage =====
    function saveToLocalStorage(data) {
      localStorage.setItem('routes', JSON.stringify(data));
    }
    function loadFromLocalStorage() {
      try {
        const raw = localStorage.getItem('routes');
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('Error leyendo localStorage:', e);
        return [];
      }
    }

    // ===== UI =====
    function updateButtons() {
      const tracking = isTracking();
      const points = currentPath.length;

      document.getElementById('btnStart').disabled  = tracking;
      document.getElementById('btnStop').disabled   = !tracking;
      document.getElementById('btnResume').disabled = tracking || points === 0;
      document.getElementById('btnSave').disabled   = points < 2;
      document.getElementById('btnClear').disabled  = points === 0;
    }

    // Mensaje útil si la key/referrer falla
    window.gm_authFailure = function() {
      alert('Fallo de autenticación de Google Maps JS API: revisa la API key y las restricciones de referrer.');
    };
  </script>

  <!-- IMPORTANTE: libraries=geometry para distancias -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBq30NO3Wr-2MySK26-3Sh8WQdjbFUjX34&libraries=geometry&callback=initMap" async defer></script>
</body>
</html>
